{% extends "layout.html" %}

{% block content %}
<div class="container">
    <div class="audit-card">
        <div class="card-header">
            <h1>Start New Audit</h1>
            <p>Enter a YouTube Video ID to begin the comprehensive compliance check.</p>
        </div>
        
	<div class="input-group">
                <input type="text" id="videoId" placeholder="Enter YouTube Video ID (e.g., 0kfLmie73dA)" value="0kfLmie73dA">
                <button id="startBtn" onclick="startAudit()">Start Audit</button>
    	</div>

    	<div style="margin-bottom: 20px; display: flex; align-items: center; gap: 8px; color: #64748b; font-size: 14px;">
		<input type="checkbox" id="debugMode">
		<label for="debugMode">Enable Full Debug Logging (Show detailed script outputs)</label>
	</div>

        <div id="status-area" style="display: none;">
            <div class="progress-steps" id="steps-container">
                </div>
            
            <div class="console-window">
                <div class="console-header">Real-time Logs</div>
                <div id="console-output" class="console-body"></div>
            </div>
        </div>
    </div>
</div>

<script>
const steps = [
    "Metadata", "Download", "Frame Split", "Audio Extract", 
    "LALAL.ai Split", "Music ID", "Visual Analysis", "Report Gen"
];

function startAudit() {

    const steps = [
        "Fetching Metadata",      // 0
        "Downloading Video",      // 1
        "Extracting Audio",       // 2 (Swapped)
        "LALAL.ai Separation",    // 3
        "Splitting Frames",       // 4 (Swapped)
        "Music Detection (ACR)",  // 5
        "Visual Analysis",        // 6
        "Compliance Report"       // 7
    ];

    const vid = document.getElementById('videoId').value.trim();
    if (!vid) return alert("Please enter a Video ID");

    document.getElementById('startBtn').disabled = true;
    document.getElementById('status-area').style.display = 'block';
    
    // Render Steps
    const stepsContainer = document.getElementById('steps-container');
    stepsContainer.innerHTML = steps.map((s, i) => 
        `<div id="step-${i}" class="step-item">
            <div class="step-icon"><i class="fa-regular fa-circle"></i></div>
            <div class="step-label">${s}</div>
        </div>`
    ).join('');

    const consoleDiv = document.getElementById('console-output');
    consoleDiv.innerHTML = '> Initializing pipeline...\n';

    const debug = document.getElementById('debugMode').checked;
    const url = '/audit/stream/' + vid + (debug ? '?debug=true' : '');
    const evtSource = new EventSource(url);
    
    evtSource.onmessage = function(e) {
        const data = JSON.parse(e.data);

        // Update Steps (Matches 'step_index' from Python)
        if (data.step_index !== undefined) {
            updateStep(data.step_index);
        }

        if (data.message) {
            consoleDiv.innerHTML += `> ${data.message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        if (data.status === 'COMPLETE') {
            evtSource.close();
            document.getElementById('startBtn').disabled = false;
            updateStep(steps.length - 1, true);
            
            // Redirect to report
            setTimeout(() => {
                window.location.href = `/report/${vid}`;
            }, 1000);
        }
    };	
    
    evtSource.onerror = function() {
        evtSource.close();
        document.getElementById('startBtn').disabled = false;
        consoleDiv.innerHTML += '\n> âŒ Connection Error.';
    };
}

function updateStep(index, isFinish=false) {
    const current = document.getElementById(`step-${index}`);
    if (current) {
        current.classList.add('active');
        current.querySelector('i').className = "fa-solid fa-spinner fa-spin";
    }
    
    // Mark previous as done
    if (index > 0 || isFinish) {
        const prevIndex = isFinish ? index : index - 1;
        const prev = document.getElementById(`step-${prevIndex}`);
        if (prev) {
            prev.classList.remove('active');
            prev.classList.add('completed');
            prev.querySelector('i').className = "fa-solid fa-check";
        }
    }
}
</script>
{% endblock %}
